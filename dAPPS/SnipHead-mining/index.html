<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnipeHead Mining</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Exo+2:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%);
            overflow-x: hidden;
        }
        h1 {
            font-family: 'Exo 2', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        h2 {
            font-family: 'Exo 2', sans-serif;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .glassmorphism:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 48px rgba(0, 255, 255, 0.3);
        }
        .pulse-button:hover:not(:disabled) {
            animation: pulse 1s infinite;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .pulse-status {
            animation: pulse-status 1.5s infinite;
        }
        @keyframes pulse-status {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        .placeholder {
            height: 1.5rem;
            width: 50%;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 4px;
        }
        .neon-glow {
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.8), 0 0 20px rgba(0, 255, 255, 0.4);
        }
        .header-animation {
            animation: neon-flicker 3s infinite;
        }
        @keyframes neon-flicker {
            0%, 100% { opacity: 1; text-shadow: 0 0 10px rgba(0, 255, 255, 0.8), 0 0 20px rgba(0, 255, 255, 0.4); }
            50% { opacity: 0.95; text-shadow: 0 0 5px rgba(0, 255, 255, 0.6); }
        }
        .bg-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: transparent;
        }
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 10s infinite linear;
        }
        @keyframes float {
            0% { transform: translateY(100vh) scale(1); opacity: 0.5; }
            100% { transform: translateY(-10vh) scale(0.5); opacity: 0; }
        }
        /* Mobile improvements */
        @media (max-width: 768px) {
            input, button {
                padding: 1rem 1.25rem;
                font-size: 1.125rem;
            }
            .grid-cols-1 {
                gap: 2.5rem;
            }
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }
        .status-link {
            color: #67e8f9;
            text-decoration: underline;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body class="text-white min-h-screen flex flex-col relative">
    <div class="bg-particles" id="particles"></div>
    <header class="bg-gradient-to-r from-blue-900/80 to-cyan-900/80 py-4 glassmorphism sticky top-0 z-10">
        <div class="container mx-auto px-4">
            <h1 class="text-4xl font-bold text-cyan-400 tracking-wider neon-glow header-animation">SnipeHead Mining</h1>
        </div>
    </header>
    <main class="container mx-auto px-4 py-8 flex-grow relative z-10">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Mining Controls -->
            <div class="glassmorphism rounded-2xl p-8 shadow-lg transition-all duration-300">
                <h2 class="text-2xl font-semibold mb-4 text-cyan-300 neon-glow">Your Mining Dashboard</h2>
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <p id="account" class="text-lg text-gray-200">Not connected</p>
                        <div id="chainIndicator" class="hidden items-center text-sm text-green-400">
                            <span class="w-2 h-2 bg-green-400 rounded-full mr-1.5"></span>
                            PulseChain
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg text-gray-200 font-medium">Token Balance:</span>
                        <span id="balance" class="text-xl text-cyan-400 font-bold flex items-center">
                            <span id="balanceValue"></span>
                            <span id="balancePlaceholder" class="placeholder animate-pulse"></span>
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg text-gray-200 font-medium">Mined Amount:</span>
                        <span id="staked" class="text-xl text-cyan-400 font-bold flex items-center">
                            <span id="stakedValue"></span>
                            <span id="stakedPlaceholder" class="placeholder animate-pulse"></span>
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg text-gray-200 font-medium">Pending Rewards:</span>
                        <span id="rewards" class="text-xl text-cyan-400 font-bold flex items-center">
                            <span id="rewardsValue"></span>
                            <span id="rewardsPlaceholder" class="placeholder animate-pulse"></span>
                        </span>
                    </div>
                    <button id="connectButton" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white py-3 px-4 rounded-lg hover:shadow-lg hover:shadow-cyan-500/50 transition-all duration-300 pulse-button disabled:bg-gray-600 disabled:cursor-not-allowed">Connect Wallet</button>
                    <div class="relative">
                        <input id="amountInput" type="text" placeholder="Amount (e.g., 1234.56 or 1,234.56)" class="w-full bg-gray-800/50 border border-gray-600/50 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-all duration-300 pr-16">
                        <button id="maxButton" class="absolute right-3 top-1/2 -translate-y-1/2 text-cyan-400 text-sm font-medium hover:text-cyan-300">MAX</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="mineButton" disabled class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white py-3 px-4 rounded-lg hover:shadow-lg hover:shadow-cyan-500/50 transition-all duration-300 pulse-button disabled:bg-gray-600 disabled:cursor-not-allowed">Mine</button>
                        <button id="unmineButton" disabled class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white py-3 px-4 rounded-lg hover:shadow-lg hover:shadow-cyan-500/50 transition-all duration-300 pulse-button disabled:bg-gray-600 disabled:cursor-not-allowed">Unmine</button>
                    </div>
                    <button id="claimButton" disabled class="w-full bg-gradient-to-r from-green-500 to-teal-500 text-white py-3 px-4 rounded-lg hover:shadow-lg hover:shadow-teal-500/50 transition-all duration-300 pulse-button disabled:bg-gray-600 disabled:cursor-not-allowed">Claim Rewards</button>
                    <div id="disconnectSection" class="hidden mt-4">
                        <button id="disconnectButton" class="w-full bg-gradient-to-r from-red-600/70 to-red-700/70 text-white py-2.5 px-4 rounded-lg hover:shadow-lg hover:shadow-red-500/40 transition-all duration-300 text-sm">Disconnect Wallet</button>
                    </div>
                    <p id="status" class="text-center text-gray-200 min-h-[1.5rem]"></p>
                </div>
            </div>
            <!-- SnipeHead Statistics -->
            <div class="glassmorphism rounded-2xl p-8 shadow-lg transition-all duration-300">
                <h2 class="text-2xl font-semibold mb-2 text-cyan-300 neon-glow">SnipeHead Statistics</h2>
                <p class="text-gray-400 italic mb-2 text-base">Mine SHD tokens while rewards are available in the pool!</p>
                <p id="statsUpdated" class="text-gray-500 text-sm mb-4">Last updated: —</p>
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <span class="text-lg text-gray-200 font-medium">APY:</span>
                        <span id="apy" class="text-xl text-cyan-400 font-bold">Loading...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg text-gray-200 font-medium">Total SHD Being Mined:</span>
                        <span id="totalMined" class="text-xl text-cyan-400 font-bold">Loading...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg text-gray-200 font-medium">Contract SHD Balance:</span>
                        <span id="contractBalance" class="text-xl text-cyan-400 font-bold">Loading...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg text-gray-200 font-medium">Available Rewards Pool:</span>
                        <span id="availableRewards" class="text-xl text-cyan-400 font-bold">Loading...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg text-gray-200 font-medium">Reward Rate:</span>
                        <span id="rewardRate" class="text-xl text-cyan-400 font-bold">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer class="bg-gradient-to-r from-blue-900/80 to-cyan-900/80 py-6 glassmorphism shadow-inner">
        <div class="container mx-auto px-4 text-center">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <h3 class="text-lg font-semibold text-cyan-300 neon-glow">Network</h3>
                    <p><a href="https://www.pulsechain.com/" target="_blank" class="text-cyan-400 hover:text-cyan-300 transition-all duration-300">PulseChain (Chain ID: 369)</a></p>
                    <p class="text-gray-400">Currency: PLS</p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-cyan-300 neon-glow">Block Explorer</h3>
                    <a href="https://ipfs.scan.pulsechain.com/address/0xF5e97b7167Fa1618965f36C08f1263b722FE60Ea?tab=contract" target="_blank" class="text-cyan-400 hover:text-cyan-300 transition-all duration-300">View Contract</a>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-cyan-300 neon-glow">Links</h3>
                    <p><a href="https://www.snipehead.xyz/" target="_blank" class="text-cyan-400 hover:text-cyan-300 transition-all duration-300">SnipeHead Portal</a></p>
                    <p><a href="https://gitlab.com/pbaieck-group/snipehead-mining" target="_blank" class="text-cyan-400 hover:text-cyan-300 transition-all duration-300">View Source</a></p>
                </div>
            </div>
            <p class="text-gray-400 text-base">
                © <span id="copyright-year">2025</span> SnipeHead Mining. All rights reserved.
            </p>
            <p class="text-gray-500 text-sm mt-2">v1.1.0</p>
        </div>
    </footer>

    <script>
        // Particle effect
        function createParticles() {
            const particleContainer = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                particle.style.left = Math.random() * 100 + 'vw';
                particle.style.animationDelay = Math.random() * 10 + 's';
                particle.style.animationDuration = Math.random() * 5 + 5 + 's';
                particleContainer.appendChild(particle);
            }
        }
        createParticles();

        const MINING_CONTRACT_ADDRESS = "0xF5e97b7167Fa1618965f36C08f1263b722FE60Ea";
        const TOKEN_CONTRACT_ADDRESS = "0x7E5A488756c3FEe54248f97a36dF5B0e9cf27d8d";
        const PULSECHAIN_RPC = "https://rpc.pulsechain.com";
        const EXPLORER_URL = "https://ipfs.scan.pulsechain.com/tx/";

        const MINING_ABI = [
            "function mine(uint256 amount, uint256 deadline, uint8 v, bytes32 r, bytes32 s) public",
            "function unmine(uint256 amount) public",
            "function claimRewards() public",
            "function pendingRewards(address account) public view returns (uint256)",
            "function userInfo(address) view returns (uint256 minedAmount, uint256 rewardDebt)",
            "function totalMined() public view returns (uint256)",
            "function getContractSHDBalance() public view returns (uint256)",
            "function rewardRate() public view returns (uint256)",
            "function lastRewardBlock() public view returns (uint256)"
        ];

        const TOKEN_ABI = [
            "function balanceOf(address account) view returns (uint256)",
            "function permit(address owner, address spender, uint256 value, uint256 deadline, uint8 v, bytes32 r, bytes32 s) public",
            "function nonces(address owner) view returns (uint256)",
            "function DOMAIN_SEPARATOR() view returns (bytes32)"
        ];

        let provider, signer, account, miningContract, tokenContract;
        let balanceInterval;
        let statsLastUpdated = null;

        const connectButton = document.getElementById('connectButton');
        const disconnectButton = document.getElementById('disconnectButton');
        const disconnectSection = document.getElementById('disconnectSection');
        const mineButton = document.getElementById('mineButton');
        const unmineButton = document.getElementById('unmineButton');
        const claimButton = document.getElementById('claimButton');
        const maxButton = document.getElementById('maxButton');
        const amountInput = document.getElementById('amountInput');
        const statusElement = document.getElementById('status');
        const chainIndicator = document.getElementById('chainIndicator');

        // Full precise formatting for user's dashboard (easy to copy)
        function formatNumberFull(num) {
            if (typeof num !== 'number' || isNaN(num)) return "—";
            const decimals = Math.abs(num) < 1 ? 6 : (Math.abs(num) < 10 ? 4 : 2);
            return num.toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        // Abbreviated formatting for global stats
        function formatNumberAbbrev(num) {
            if (typeof num !== 'number' || isNaN(num)) return "—";
            const absNum = Math.abs(num);
            if (absNum >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (absNum >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (absNum >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function updateLastUpdated() {
            if (!statsLastUpdated) return;
            const diffSec = Math.floor((Date.now() - statsLastUpdated) / 1000);
            let text = "just now";
            if (diffSec >= 120) text = Math.floor(diffSec / 60) + " min ago";
            else if (diffSec >= 60) text = "1 min ago";
            else if (diffSec > 10) text = diffSec + " sec ago";
            document.getElementById('statsUpdated').textContent = `Last updated: ${text}`;
        }

        async function init() {
            try {
                provider = window.ethereum || window.web3
                    ? new ethers.providers.Web3Provider(window.ethereum || window.web3.currentProvider)
                    : new ethers.providers.JsonRpcProvider(PULSECHAIN_RPC);

                const network = await provider.getNetwork();
                if (network.chainId !== 369 && provider instanceof ethers.providers.Web3Provider) {
                    try {
                        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x171' }] });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x171',
                                    chainName: 'PulseChain',
                                    rpcUrls: ['https://rpc.pulsechain.com'],
                                    nativeCurrency: { name: 'Pulse', symbol: 'PLS', decimals: 18 },
                                    blockExplorerUrls: ['https://ipfs.scan.pulsechain.com']
                                }]
                            });
                        } else {
                            setStatus("Failed to switch to PulseChain", "text-red-500");
                            return;
                        }
                    }
                }

                miningContract = new ethers.Contract(MINING_CONTRACT_ADDRESS, MINING_ABI, provider);
                tokenContract = new ethers.Contract(TOKEN_CONTRACT_ADDRESS, TOKEN_ABI, provider);

                updateNetworkStats();
                setInterval(updateNetworkStats, 30000);
                setInterval(updateLastUpdated, 30000);

                if (window.ethereum || window.web3) {
                    connectButton.addEventListener('click', connectWallet);
                } else {
                    setStatus("No wallet detected. Stats still available.", "text-yellow-500");
                    connectButton.disabled = true;
                }
            } catch (err) {
                setStatus("Initialization failed", "text-red-500");
            }
        }

        async function connectWallet() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                account = accounts[0];
                document.getElementById('account').textContent = `Connected: ${account.slice(0,6)}...${account.slice(-4)}`;
                connectButton.classList.add('hidden');
                disconnectSection.classList.remove('hidden');
                chainIndicator.classList.remove('hidden');

                [mineButton, unmineButton, claimButton].forEach(btn => btn.disabled = false);

                signer = provider.getSigner();
                miningContract = miningContract.connect(signer);
                tokenContract = tokenContract.connect(signer);

                updateBalances();
                balanceInterval = setInterval(updateBalances, 30000);

                setStatus("Wallet connected", "text-green-500");

                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) disconnectWallet();
                });
            } catch (err) {
                setStatus("Connection failed", "text-red-500");
            }
        }

        function disconnectWallet() {
            account = null;
            signer = null;
            clearInterval(balanceInterval);

            document.getElementById('account').textContent = 'Not connected';
            connectButton.classList.remove('hidden');
            disconnectSection.classList.add('hidden');
            chainIndicator.classList.add('hidden');

            connectButton.textContent = 'Connect Wallet';
            connectButton.disabled = false;
            [mineButton, unmineButton, claimButton].forEach(btn => btn.disabled = true);

            document.getElementById('balanceValue').textContent = '';
            document.getElementById('stakedValue').textContent = '';
            document.getElementById('rewardsValue').textContent = '';
            document.getElementById('balancePlaceholder').classList.remove('hidden');
            document.getElementById('stakedPlaceholder').classList.remove('hidden');
            document.getElementById('rewardsPlaceholder').classList.remove('hidden');

            setStatus("Wallet disconnected", "text-yellow-500");
        }

        async function updateBalances() {
            if (!account) return;
            try {
                const balance = await tokenContract.balanceOf(account);
                document.getElementById('balanceValue').textContent = formatNumberFull(Number(ethers.utils.formatEther(balance))) + " SHD";
                document.getElementById('balancePlaceholder').classList.add('hidden');

                const userInfo = await miningContract.userInfo(account);
                document.getElementById('stakedValue').textContent = formatNumberFull(Number(ethers.utils.formatEther(userInfo.minedAmount))) + " SHD";
                document.getElementById('stakedPlaceholder').classList.add('hidden');

                const rewards = await miningContract.pendingRewards(account);
                document.getElementById('rewardsValue').textContent = formatNumberFull(Number(ethers.utils.formatEther(rewards))) + " SHD";
                document.getElementById('rewardsPlaceholder').classList.add('hidden');
            } catch (err) {
                console.error("Balance update error:", err);
            }
        }

        async function updateNetworkStats() {
            try {
                const totalMined = await miningContract.totalMined();
                const totalMinedNum = Number(ethers.utils.formatEther(totalMined));
                document.getElementById('totalMined').textContent = formatNumberAbbrev(totalMinedNum) + " SHD";

                const contractBalance = await miningContract.getContractSHDBalance();
                const contractBalanceNum = Number(ethers.utils.formatEther(contractBalance));
                document.getElementById('contractBalance').textContent = formatNumberAbbrev(contractBalanceNum) + " SHD";

                let availableRewards = contractBalanceNum - totalMinedNum;
                if (availableRewards < 0) availableRewards = 0;
                document.getElementById('availableRewards').textContent = formatNumberAbbrev(availableRewards) + " SHD";

                const rewardRate = await miningContract.rewardRate();
                document.getElementById('rewardRate').textContent = `${Number(ethers.utils.formatEther(rewardRate)).toLocaleString('en-US', { minimumFractionDigits: 18, maximumFractionDigits: 18 })} SHD/block/SHD`;

                const blocksPerYear = (365 * 24 * 60 * 60) / 10;
                const apy = Number(ethers.utils.formatEther(rewardRate)) * blocksPerYear * 100;
                document.getElementById('apy').textContent = `${apy.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}%`;

                statsLastUpdated = Date.now();
                updateLastUpdated();
            } catch (err) {
                document.getElementById('apy').textContent = 'Error';
                document.getElementById('totalMined').textContent = 'Error';
                document.getElementById('contractBalance').textContent = 'Error';
                document.getElementById('availableRewards').textContent = 'Error';
                document.getElementById('rewardRate').textContent = 'Error';
                setStatus("Failed to load stats", "text-red-500");
            }
        }

        async function handleMine() {
            if (!signer) return setStatus("Connect wallet first", "text-red-500");
            let amount = amountInput.value.trim().replace(/,/g, '');
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) return setStatus("Enter valid amount", "text-red-500");

            try {
                setStatus("This action requires **two steps**:<br>1. Permit approval (signature, no gas)<br>2. Mining transaction (requires gas)", "text-cyan-400 pulse-status");
                mineButton.disabled = true;

                const amountWei = ethers.utils.parseEther(amount);
                const deadline = Math.floor(Date.now() / 1000) + 60 * 20;
                const owner = account;
                const spender = MINING_CONTRACT_ADDRESS;
                const nonce = await tokenContract.nonces(owner);

                const domain = {
                    name: "SnipeHead",
                    version: "1",
                    chainId: 369,
                    verifyingContract: TOKEN_CONTRACT_ADDRESS
                };

                const types = {
                    Permit: [
                        { name: "owner", type: "address" },
                        { name: "spender", type: "address" },
                        { name: "value", type: "uint256" },
                        { name: "nonce", type: "uint256" },
                        { name: "deadline", type: "uint256" }
                    ]
                };

                const message = { owner, spender, value: amountWei, nonce, deadline };
                const signature = await signer._signTypedData(domain, types, message);
                const { v, r, s } = ethers.utils.splitSignature(signature);

                setStatus("Submitting mining transaction... <br>(this is step 2/2)", "text-cyan-400 pulse-status");
                const tx = await miningContract.mine(amountWei, deadline, v, r, s);
                setStatus(`Mining in progress... <a href="${EXPLORER_URL}${tx.hash}" target="_blank" class="status-link">View tx</a>`, "text-cyan-400");

                await tx.wait();
                setStatus(`Mining successful! <a href="${EXPLORER_URL}${tx.hash}" target="_blank" class="status-link">View tx</a>`, "text-green-500");
                amountInput.value = "";
                updateBalances();
                updateNetworkStats();
            } catch (err) {
                if (err.code === 4001) setStatus("Transaction rejected", "text-red-500");
                else if (err.message?.includes("insufficient funds")) setStatus("Not enough PLS for gas", "text-red-500");
                else setStatus("Mining failed: " + (err.reason || err.message || "unknown error"), "text-red-500");
            } finally {
                mineButton.disabled = false;
            }
        }

        async function handleUnmine() {
            if (!signer) return setStatus("Connect wallet first", "text-red-500");
            let amount = amountInput.value.trim().replace(/,/g, '');
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) return setStatus("Enter valid amount", "text-red-500");

            try {
                setStatus("Sending unmine transaction...", "text-cyan-400 pulse-status");
                unmineButton.disabled = true;

                const amountWei = ethers.utils.parseEther(amount);
                const tx = await miningContract.unmine(amountWei);
                setStatus(`Unmining in progress... <a href="${EXPLORER_URL}${tx.hash}" target="_blank" class="status-link">View tx</a>`, "text-cyan-400");

                await tx.wait();
                setStatus(`Unmined successfully! <a href="${EXPLORER_URL}${tx.hash}" target="_blank" class="status-link">View tx</a>`, "text-green-500");
                amountInput.value = "";
                updateBalances();
                updateNetworkStats();
            } catch (err) {
                if (err.code === 4001) setStatus("Transaction rejected", "text-red-500");
                else setStatus("Unmine failed: " + (err.reason || err.message || "unknown"), "text-red-500");
            } finally {
                unmineButton.disabled = false;
            }
        }

        async function handleClaim() {
            if (!signer) return setStatus("Connect wallet first", "text-red-500");

            try {
                setStatus("Sending claim transaction...", "text-cyan-400 pulse-status");
                claimButton.disabled = true;

                const tx = await miningContract.claimRewards();
                setStatus(`Claim in progress... <a href="${EXPLORER_URL}${tx.hash}" target="_blank" class="status-link">View tx</a>`, "text-cyan-400");

                await tx.wait();
                setStatus(`Claim successful! <a href="${EXPLORER_URL}${tx.hash}" target="_blank" class="status-link">View tx</a>`, "text-green-500");
                updateBalances();
                updateNetworkStats();
            } catch (err) {
                if (err.code === 4001) setStatus("Transaction rejected", "text-red-500");
                else setStatus("Claim failed: " + (err.reason || err.message || "unknown"), "text-red-500");
            } finally {
                claimButton.disabled = false;
            }
        }

        function setStatus(message, className = "text-gray-200") {
            statusElement.innerHTML = message;
            statusElement.className = `text-center ${className}`;
        }

        // Event listeners
        mineButton.addEventListener('click', handleMine);
        unmineButton.addEventListener('click', handleUnmine);
        claimButton.addEventListener('click', handleClaim);
        disconnectButton.addEventListener('click', disconnectWallet);

        maxButton.addEventListener('click', async () => {
            if (!account) return setStatus("Connect wallet first", "text-red-500");
            try {
                const bal = await tokenContract.balanceOf(account);
                const balNum = Number(ethers.utils.formatEther(bal));
                amountInput.value = Math.floor(balNum).toString();
            } catch (err) {
                setStatus("Could not fetch balance", "text-red-500");
            }
        });

        // Auto-update copyright year
        document.getElementById('copyright-year').textContent = new Date().getFullYear();

        init();
    </script>
</body>
</html>